# GitLab CI configuration for the "HenDi-ODD"
variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  DOCKER_HOST: tcp://localhost:2375
  IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
  GIT_SUBMODULE_STRATEGY: recursive

stages:
  - build
  - test
  - save

.install_dependencies:
  image: ubuntu
  before_script:
    - apt update -y
    #- apt upgrade -y
    - apt install -y gnupg2 curl
    - apt install -y --no-install-recommends ant git
    - git config user.email "dennis.ried@uni-paderborn.de"
    - git config user.name "CI-Bot"

places-build:
  stage: build
  extends: .install_dependencies
  script:
    - ant places
  only:
    refs:
      - merge_requests
      #- develop
    changes:
      - src/Specs/schemaSpec-places.odd.xml
      - src/Specs/common-specs.odd.xml

places-test:
  stage: test
  extends: .install_dependencies
  needs: 
    - job: places-build
  script:
    - ant check-rng-output -DselectedSchema=hwhPlaces

places-save:
  stage: save
  extends: .install_dependencies
  needs:
    - job: places-build
    - job: places-test

  script:
    - git remote add gitlab_origin $CI_REPOSITORY_URL
    - git add .
    - git commit -m "push back from pipeline"
    - git push gitlab_origin HEAD:$CI_COMMIT_REF_SLUG -o ci.skip # prevent triggering pipeline again