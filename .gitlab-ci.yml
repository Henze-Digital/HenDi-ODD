# GitLab CI configuration for the "HenDi-ODD"
variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
  HENDI_CI_DOCKER_IMAGE: "registry.git.uni-paderborn.de/vife/henze-digital/hendi-ci-docker-image:develop"
  GIT_SUBMODULE_STRATEGY: recursive
  GIT_DEPTH: 10

default:
  image: $HENDI_CI_DOCKER_IMAGE
  
stages:
  - compile

.git_setup:
  script:
    - git config user.email "${GITLAB_USER_EMAIL}"
    - git config user.name "${GITLAB_USER_NAME}"
    - git config pull.rebase true
    - git remote set-url origin https://${HENDI_ODD_CI_TOKEN_NAME}:${HENDI_ODD_CI_TOKEN}@git.uni-paderborn.de/vife/henze-digital/HenDi-ODD.git
    - git pull origin ${CI_COMMIT_REF_NAME}

.git_commit:
  script:
    - git add .
    - git commit -m "${CI_JOB_NAME} auto compile"
    - git push origin HEAD:${CI_COMMIT_REF_NAME} -o ci.skip

.default_rules:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - changes:
      - src/Specs/common-specs.odd.xml

.compile-target:
  resource_group: compilation
  script:
    - !reference [.git_setup, script]
    - ant ${CI_JOB_NAME}
    - ant check-rng-output -DselectedSchema=${CI_JOB_NAME}
    - >
      if [ "$CI_PIPELINE_SOURCE" == "merge_request_event" ]; then
        echo "Merge Request. Results will not be committed."
      else
        !reference [.git_commit, script]
      fi
  rules:
    - !reference [.default_rules, rules]
    - changes:
      - src/Specs/schemaSpec-${CI_JOB_NAME}.odd.xml

.compile-text:
  resource_group: compilation
  script:
    - !reference [.git_setup, script]
    - ant ${CI_JOB_NAME}
    - !reference [.git_commit, script]
  rules:
    - !reference [.default_rules, rules]
    - changes:
      - src/Guidelines/de/*.xml
      - src/Specs/schemaSpec-${CI_JOB_NAME}.odd.xml

hendiBiblio:
  stage: compile
  extends: .compile-target

hendiDocuments:
  stage: compile
  extends: .compile-target

hendiLetters:
  stage: compile
  extends: .compile-target

hendiNews:
  stage: compile
  extends: .compile-target

hendiOrgs:
  stage: compile
  extends: .compile-target

hendiPersons:
  stage: compile
  extends: .compile-target

hendiPlaces:
  stage: compile
  extends: .compile-target

hendiThematicCommentaries:
  stage: compile
  extends: .compile-target

hendiVar:
  stage: compile
  extends: .compile-target

hendiWorksAV:
  stage: compile
  extends: .compile-target

hendiWorksMEI:
  stage: compile
  extends: .compile-target

hendiWorksTEI:
  stage: compile
  extends: .compile-target

hendiWritings:
  stage: compile
  extends: .compile-target

text:
  stage: compile
  extends: .compile-text