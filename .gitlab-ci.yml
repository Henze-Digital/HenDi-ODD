# GitLab CI configuration for the "HenDi-ODD"
variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
  HENDI_CI_DOCKER_IMAGE: "registry.git.uni-paderborn.de/vife/henze-digital/hendi-ci-docker-image:develop"
  GIT_SUBMODULE_STRATEGY: recursive
  GIT_DEPTH: 10

default:
  image: $HENDI_CI_DOCKER_IMAGE
  
stages:
  - build
  - test
  - save
  - build-text

.setup_git:
  before_script:
    - git config user.email "${GITLAB_USER_EMAIL}"
    - git config user.name "${GITLAB_USER_NAME}"
    - git remote set-url origin https://${HENDI_ODD_CI_TOKEN_NAME}:${HENDI_ODD_CI_TOKEN}@git.uni-paderborn.de/vife/henze-digital/HenDi-ODD.git

biblio-build:
  stage: build
  script:
    - ant biblio
  only:
    changes:
      - src/Specs/schemaSpec-biblio.odd.xml
      - src/Specs/common-specs.odd.xml

biblio-test:
  stage: test
  needs: 
    - job: biblio-build
  script:
    - ant check-rng-output -DselectedSchema=hwhBiblio
  only:
    changes:
      - src/Specs/schemaSpec-biblio.odd.xml
      - src/Specs/common-specs.odd.xml

biblio-save:
  stage: save
  extends: .setup_git
  needs: 
    - job: biblio-test
  script:
    - git pull origin ${CI_COMMIT_REF_NAME}
    - ant biblio
    - git add .
    - git commit -m "auto compile schema biblio"
    - git push origin HEAD:${CI_COMMIT_REF_NAME} -o ci.skip
  only:
    changes:
      - src/Specs/schemaSpec-biblio.odd.xml
      - src/Specs/common-specs.odd.xml

places-build:
  stage: build
  script:
    - ant places
  only:
    changes:
      - src/Specs/schemaSpec-places.odd.xml
      - src/Specs/common-specs.odd.xml

places-test:
  stage: test
  needs: 
    - job: places-build
  script:
    - ant check-rng-output -DselectedSchema=hwhPlaces

places-save:
  stage: save
  extends: .setup_git
  needs: 
    - job: places-test
    - job: biblio-save
      optional: true
  script:
    - git pull origin ${CI_COMMIT_REF_NAME}
    - ant places
    - git add .
    - git commit -m "auto compile schema places"
    - git push origin HEAD:${CI_COMMIT_REF_NAME} -o ci.skip